<!DOCTYPE html>
<html>
  <head>
    <title>Chat Tiburoncín</title>
  </head>
  <body>
    <script type="application/javascript">


      document.addEventListener("DOMContentLoaded", function () {
        const ul = document.createElement("ul");
        const input = document.createElement("input");
        const sendButton = document.createElement("button");
        input.type = "text";
        input.placeholder = "Escribe un mensaje";
        sendButton.textContent = "Enter";

        document.body.appendChild(ul);
        document.body.appendChild(input);
        document.body.appendChild(sendButton);

        const scrollToBottom = () => {
          ul.scrollTop = ul.scrollHeight;
        };
// (10 puntos) Por colocar el campo de texto para escribir el mensaje en la parte inferior de la pantalla (no debe ocultarse cuando hay muchos mensajes)
        const maxMessages = 20;   
        const messagesList = []; 
        const urlRegex = /https?:\/\/\S+\.(jpg|jpeg|png|gif)/g;

// (20 puntos) Por implementar async y await de una manera semanticamente correcta
        const getMessages = async () => {
          try {
            const response = await fetch("https://chat.tiburoncin.lat/messages");
            const messages = await response.json();
            const atBottom =
              ul.scrollHeight - ul.clientHeight <= ul.scrollTop + 1;

            messagesList.push(...messages.reverse());
            messagesList.splice(0, messagesList.length - maxMessages);
            ul.innerHTML = "";

            messagesList.forEach((messageData) => {
// (10 puntos) Por utilizar deconstrucción de objetos al menos una vez
              const { username, message, timestamp } = messageData;
              const li = document.createElement("li");
              const imageUrls = message.match(urlRegex);

              imageUrls &&
                imageUrls.forEach((url) => {
                  const img = document.createElement("img");
                  img.src = url;
                  img.style.maxWidth = "200px";
                  img.style.marginTop = "10px";
                  li.appendChild(img);
                });


              li.textContent = `${username}: ${message}`;
              ul.appendChild(li);
              
              if (atBottom) {
                scrollToBottom();
              }
              
              const shouldScrollToBottom = ul.scrollTop + ul.clientHeight === ul.scrollHeight;
              if (shouldScrollToBottom) {
                ul.scrollTop = ul.scrollHeight;
              }
            });
            
          } catch (error) {
            console.error("Hubo un problema en fetch:", error);
          }
        };

        const postMessage = async () => {
          const username = "Usuario";
          const message = input.value.trim();
// (10 puntos) Por limitar la cantidad de caracteres permitidos a 140 en cada mensaje 
          const maxMessageLength = 140;
          if (message === "" || message.length > maxMessageLength) {
            const errorButton = document.createElement("button");
            errorButton.textContent = "Tu mensaje es muy largo";
            
            errorButton.addEventListener("click", function () {
              input.value = "";
              document.body.removeChild(errorButton)});
            
            document.body.appendChild(errorButton);
            
            return;
          }

          if (message === "") {
            return;
          }

          const body = { username, message };

          try {
            await fetch("https://chat.tiburoncin.lat/messages", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            });

            getMessages();
            input.value = "";
          } catch (error) {
            console.error("Hubo un problema al enviar el mensaje:", error);
          }
        };

// (10 puntos) Por agregar hacer "submit" del mensaje utilizando "Enter" 
        input.addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            event.preventDefault();
            postMessage();
          }
        });

        sendButton.addEventListener("click", postMessage);
// (10 puntos) Auto-refresh de la lista de mensajes (no puede ser menor a 5 segundos)
        setInterval(getMessages, 5000);

        getMessages();
      });



    </script>
  </body>
</html>
